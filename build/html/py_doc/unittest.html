

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>21. unittest单元测试 &mdash; openstack 1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Hack Linux" href="../linux_tools/index.html" />
    <link rel="prev" title="20. django国际化" href="django-i18n.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> openstack
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Python Note</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="pysnmp_doc.html">1. [翻译] PySNMP教程</a></li>
<li class="toctree-l2"><a class="reference internal" href="pysnmp_doc_example.html">2. PySNMP获取设备信息</a></li>
<li class="toctree-l2"><a class="reference internal" href="re_doc.html">3. [翻译] Python正则表达式</a></li>
<li class="toctree-l2"><a class="reference internal" href="wsgi.html">4. WSGI基础</a></li>
<li class="toctree-l2"><a class="reference internal" href="re_analysis.html">5. Python正则表达式分析利器</a></li>
<li class="toctree-l2"><a class="reference internal" href="python_descriptor.html">6. Python描述器</a></li>
<li class="toctree-l2"><a class="reference internal" href="python_notebook.html">7. Python学习总结</a></li>
<li class="toctree-l2"><a class="reference internal" href="python_coding.html">8. Python 编码问题总结</a></li>
<li class="toctree-l2"><a class="reference internal" href="dec_logic.html">9. Python 装饰器、闭包</a></li>
<li class="toctree-l2"><a class="reference internal" href="webob_analysis.html">10. webob库简单分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="metaclass_intro.html">11. Python元类</a></li>
<li class="toctree-l2"><a class="reference internal" href="os_lib.html">12. Python Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="log_summary.html">13. logging 模块总结</a></li>
<li class="toctree-l2"><a class="reference internal" href="django_note.html">14. django笔记</a></li>
<li class="toctree-l2"><a class="reference internal" href="python_path.html">15. Python文件与目录操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="sqlalchemy.html">16. sqlalchemy笔记</a></li>
<li class="toctree-l2"><a class="reference internal" href="time_date.html">17. Python时间和日期操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="pecan_note.html">18. pecan学习示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="stevedemo.html">19. stevedore库学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="django-i18n.html">20. django国际化</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">21. unittest单元测试</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id3">21.1. 基本概念</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">21.2. 核心实现</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#test">21.2.1. test加载</a></li>
<li class="toctree-l4"><a class="reference internal" href="#test-fixture">21.2.2. test-fixture</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id5">21.3. 参考</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../linux_tools/index.html">Hack Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../openstack/index.html">OpenStack Note</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network/index.html">网络技术/neutron</a></li>
<li class="toctree-l1"><a class="reference internal" href="../others/index.html">未分类</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">openstack</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Python Note</a> &raquo;</li>
        
      <li>21. unittest单元测试</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/py_doc/unittest.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="unittest">
<span id="id1"></span><h1><a class="toc-backref" href="#id8">21. unittest单元测试</a><a class="headerlink" href="#unittest" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="id2">
<p class="topic-title first">目录</p>
<ul class="simple">
<li><a class="reference internal" href="#unittest" id="id8">unittest单元测试</a><ul>
<li><a class="reference internal" href="#id3" id="id9">基本概念</a></li>
<li><a class="reference internal" href="#id4" id="id10">核心实现</a><ul>
<li><a class="reference internal" href="#test" id="id11">test加载</a></li>
<li><a class="reference internal" href="#test-fixture" id="id12">test-fixture</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id5" id="id13">参考</a></li>
</ul>
</li>
</ul>
</div>
<hr class="docutils" />
<p>最近花时间研究了下python的单元测试框架unittest，
在简要熟悉了该框架的用法之后，简要分析了下该框架的源码，
现在从源代码的角度，来对xUnit单元测试的一些基本概念和核心原理进行讲解。</p>
<p>先给出简单的用法示例：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">clog</span>

<span class="k">class</span> <span class="nc">Mydemo</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s1">&#39;&lt;+&#39;</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="nb">print</span> <span class="s2">&quot;in test setUp&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">=</span><span class="mi">1</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;tear down&quot;</span>
        <span class="c1">#self.a=1</span>
        <span class="nb">print</span> <span class="s1">&#39;+&gt;&#39;</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="nb">print</span>

    <span class="k">def</span> <span class="nf">test1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;i am test1 the value of a is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;i am test2 the value of a is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>

    <span class="k">def</span>  <span class="nf">test3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;i am test3 the value of a is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">TestStringMethods</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s1">&#39;&lt;+&#39;</span> <span class="o">*</span> <span class="mi">10</span> <span class="p">,</span> <span class="s2">&quot;in test setUp&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">clog</span><span class="o">.</span><span class="n">LOG_STACK</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;tear down&quot;</span><span class="p">,</span> <span class="s1">&#39;+&gt;&#39;</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="nb">print</span>
        <span class="n">clog</span><span class="o">.</span><span class="n">LOG_STACK</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;++&quot;</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">+</span> <span class="s2">&quot;setupclass&quot;</span> <span class="o">+</span> <span class="s2">&quot;++&quot;</span> <span class="o">*</span> <span class="mi">5</span>
        <span class="n">clog</span><span class="o">.</span><span class="n">LOG_STACK</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">tearDownClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;==&quot;</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">+</span> <span class="s2">&quot;tearDownClass&quot;</span> <span class="o">+</span> <span class="s2">&quot;==&quot;</span> <span class="o">*</span> <span class="mi">5</span>
        <span class="n">clog</span><span class="o">.</span><span class="n">LOG_STACK</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_upper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;test_upper&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="s1">&#39;FOO&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="s1">&#39;FOO9&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_isupper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;test_isupper&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;FOO&#39;</span><span class="o">.</span><span class="n">isupper</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="s1">&#39;Foo&#39;</span><span class="o">.</span><span class="n">isupper</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">test_split</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;test_issplit&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;FOO&#39;</span><span class="o">.</span><span class="n">isupper</span><span class="p">())</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;hello world&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="p">[</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">])</span>
        <span class="c1"># check that s.split fails when the separator is not a string</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">setUpModule</span><span class="p">():</span>
    <span class="nb">print</span> <span class="s2">&quot;&lt;start&gt;&quot;</span> <span class="o">*</span> <span class="mi">3</span>
    <span class="n">clog</span><span class="o">.</span><span class="n">LOG_STACK</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">tearDownModule</span><span class="p">():</span>
    <span class="nb">print</span> <span class="s2">&quot;&lt;end&gt;&quot;</span> <span class="o">*</span> <span class="mi">5</span>
    <span class="n">clog</span><span class="o">.</span><span class="n">LOG_STACK</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>大家自行运行上面的例子，后面会结合相关的概念，从源代码角度对运行结果进行分析。</p>
<div class="section" id="id3">
<h2><a class="toc-backref" href="#id9">21.1. 基本概念</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<dl class="attribute">
<dt id="TestCase">
<code class="descname">TestCase</code><a class="headerlink" href="#TestCase" title="Permalink to this definition">¶</a></dt>
<dd><p>一个testcase是测试中最小的一个单元，它用于检查特定的一组输入或响应，
unittest中提供了一个TestCase类，可以用来创建新的测试用例。</p>
<p><strong>需要注意一点，每一个继承自TestCase类，并且以test开头的方法，都是一个测试用例。
如TestStringMethods类有三个以test开头的方法，那么会根据这三个方法，
生成三个TestCase实例(然后根据这三个testcase实例，生成一个testsuite)。</strong></p>
</dd></dl>

<dl class="attribute">
<dt id="TestSuite">
<code class="descname">TestSuite</code><a class="headerlink" href="#TestSuite" title="Permalink to this definition">¶</a></dt>
<dd><p>可迭代对象，他的每一个元素是TestCase实例或者是其他TestSuite实例。</p>
<p>比如上面的例子，Mydemo和TestStringMethods会各生成一个TestSuite实例，
最后根据这两个suite实例生成一个suite实例。</p>
<p><strong>testsuite实例是可迭代的，testcase不可迭代。</strong></p>
</dd></dl>

<dl class="attribute">
<dt id="TestLoader">
<code class="descname">TestLoader</code><a class="headerlink" href="#TestLoader" title="Permalink to this definition">¶</a></dt>
<dd><p>用来加载TestCase到TestSuite中，
其中的方法从各个地方寻找TestCase，创建它们的实例，
然后add到TestSuite中，返回一个TestSuite实例。</p>
</dd></dl>

<dl class="attribute">
<dt id="TestRunner">
<code class="descname">TestRunner</code><a class="headerlink" href="#TestRunner" title="Permalink to this definition">¶</a></dt>
<dd><p>驱动执行测试，并输出测试结果呈现给用户。</p>
<p>TestRunner有一个关键的stream参数，表示要将测试的结果，格式化输出到什么地方(默认是sys.stderr)。</p>
</dd></dl>

<dl class="attribute">
<dt id="TestResult">
<code class="descname">TestResult</code><a class="headerlink" href="#TestResult" title="Permalink to this definition">¶</a></dt>
<dd><p>保存测试结果。包括运行用例数，成功数，失败数等。</p>
<p>关于测试结果，我们需要注意测试错误和测试失败的区别。来看官网的描述：</p>
<p><cite>If the test fails, an exception will be raised, and unittest will identify the test case as a failure. Any other exceptions will be treated as errors. This helps you identify where the problem is: failures are caused by incorrect results - a 5 where you expected a 6. Errors are caused by incorrect code - e.g., a TypeError caused by an incorrect function call.</cite></p>
<p>简而言之，测试失败表示对于要测试的函数，没有得到预期的结果。
而测试错误，表示测试代码本身有问题。</p>
</dd></dl>

<dl class="attribute">
<dt>
<code class="descname">test-fixture</code></dt>
<dd><p>测试固件，不同于以上概念在unittest框架源代码中都有对应的实体(如有TestCase类、TestSuite类)，
在unittest源码中并没有直接体现出test-fixture。可以认为这是一个逻辑上的概念，
表示每运行一个测试用例时，事先的准备工作(如打开文件、连接数据)、
执行测试本身和测试完毕的清理工作等整个流程。</p>
<p>对应在源码级别，可以通过setUpModule/setUpClass/setUp等方式，对测试流程进行精细控制。</p>
</dd></dl>

</div>
<div class="section" id="id4">
<h2><a class="toc-backref" href="#id10">21.2. 核心实现</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<div class="section" id="test">
<h3><a class="toc-backref" href="#id11">21.2.1. test加载</a><a class="headerlink" href="#test" title="Permalink to this headline">¶</a></h3>
<p>以我们上面的测试代码为例，从module中加载tests，通过loadTestsFromModule方法实现。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 对每一个TestCase派生类，生成一个TestSuite实例，</span>
<span class="c1"># TestSuite实例保存着以test开头的方法。</span>
<span class="k">def</span> <span class="nf">loadTestsFromTestCase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testCaseClass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a suite of all tests cases contained in testCaseClass&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">testCaseClass</span><span class="p">,</span> <span class="n">suite</span><span class="o">.</span><span class="n">TestSuite</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Test cases should not be derived from TestSuite.&quot;</span> \
                            <span class="s2">&quot; Maybe you meant to derive from TestCase?&quot;</span><span class="p">)</span>
    <span class="n">testCaseNames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTestCaseNames</span><span class="p">(</span><span class="n">testCaseClass</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">testCaseNames</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">testCaseClass</span><span class="p">,</span> <span class="s1">&#39;runTest&#39;</span><span class="p">):</span>
        <span class="n">testCaseNames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;runTest&#39;</span><span class="p">]</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">testCaseClass</span><span class="p">,</span> <span class="n">testCaseNames</span><span class="p">)</span>
    <span class="n">loaded_suite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">suiteClass</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loaded_suite</span>

<span class="c1"># 从模块中加载tests，返回的结果是TestSuite实例。</span>
<span class="k">def</span> <span class="nf">loadTestsFromModule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">use_load_tests</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a suite of all tests cases contained in the given module&quot;&quot;&quot;</span>
    <span class="n">tests</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">case</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
            <span class="n">tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loadTestsFromTestCase</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>

    <span class="c1"># 从这里可以看到，我们可以针对模块自定义test加载方法。</span>
    <span class="c1"># 在模块中定义一个load_tests函数即可。</span>
    <span class="n">load_tests</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;load_tests&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">tests</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">suiteClass</span><span class="p">(</span><span class="n">tests</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_load_tests</span> <span class="ow">and</span> <span class="n">load_tests</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">load_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tests</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_make_failed_load_tests</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">suiteClass</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tests</span>

<span class="c1"># 从TestCase类中查找所有的以test开头的函数。</span>
<span class="c1"># 返回列表。</span>
<span class="k">def</span> <span class="nf">getTestCaseNames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testCaseClass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a sorted sequence of method names found within testCaseClass</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">isTestMethod</span><span class="p">(</span><span class="n">attrname</span><span class="p">,</span> <span class="n">testCaseClass</span><span class="o">=</span><span class="n">testCaseClass</span><span class="p">,</span>
                     <span class="n">prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testMethodPrefix</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">attrname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="ow">and</span> \
            <span class="nb">hasattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">testCaseClass</span><span class="p">,</span> <span class="n">attrname</span><span class="p">),</span> <span class="s1">&#39;__call__&#39;</span><span class="p">)</span>
    <span class="n">testFnNames</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">isTestMethod</span><span class="p">,</span> <span class="nb">dir</span><span class="p">(</span><span class="n">testCaseClass</span><span class="p">))</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortTestMethodsUsing</span><span class="p">:</span>
        <span class="n">testFnNames</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">_CmpToKey</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortTestMethodsUsing</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">testFnNames</span>
</pre></div>
</div>
</div>
<div class="section" id="test-fixture">
<h3><a class="toc-backref" href="#id12">21.2.2. test-fixture</a><a class="headerlink" href="#test-fixture" title="Permalink to this headline">¶</a></h3>
<p>测试固件那一套复杂的控制逻辑，主要是通过TestResult来实现的。</p>
<p>还是以上面的测试代码为例进行说明：</p>
<ul class="simple">
<li>setUp/tearDown对每个TestCase都会执行(每个test都是一个Testcase)。</li>
<li>setUpClass/tearDownClass，对每个TestCase-subclass执行一次。(如果setUpClass发生异常，</li>
</ul>
<p>则该class中的test都不会执行，tearDownClass也不会被执行)
- setUpModule/tearDownModule，对每个模块执行一次。(如果setUpModule执行发生异常，
那么该模块中所有的test和tearDownModule都不会被执行)</p>
<p><strong>注意，TestResult类是用来简单保存测试结果的。至于测试结果的格式化输出，则不是这个类的任务。
unittest中有一个TextTestResult类，可以对测试输出结果信息进行控制显示(如使用-v参数)</strong>。
当然，我们可以通过继承TestResult来，来定制自己的test-result。</p>
<p>在整个测试过程中，有且仅有一个test-result对象。所有的test执行过程中，
都会以test-result对象作为参数，原地记录并更改测试结果信息。</p>
<p>其次，在测试过程中，利用TestResult的三个关键类属性，对控制逻辑实现精确控制。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestResult</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">_previousTestClass</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_testRunEntered</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_moduleSetUpFailed</span> <span class="o">=</span> <span class="kc">False</span>

<span class="o">......</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">topLevel</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;_testRunEntered&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_testRunEntered</span> <span class="o">=</span> <span class="n">topLevel</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">shouldStop</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="n">_isnotsuite</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tearDownPreviousClass</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handleModuleFixture</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handleClassSetUp</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">_previousTestClass</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="vm">__class__</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="s1">&#39;_classSetupFailed&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;_moduleSetUpFailed&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)):</span>
                <span class="k">continue</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">test</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">test</span><span class="o">.</span><span class="n">debug</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">topLevel</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tearDownPreviousClass</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handleModuleTearDown</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">_testRunEntered</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>通过_testRunEntered属性，标记测试开始，通过配合toplevel参数，实现setUpModule/ tearDownModule逻辑。</p>
<p>其次，在每执行一个test过程中，会对比当前test所属的TestCaseClass和_previousTestClass：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_handleClassSetUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
    <span class="n">previousClass</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;_previousTestClass&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">currentClass</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="vm">__class__</span>
    <span class="k">if</span> <span class="n">currentClass</span> <span class="o">==</span> <span class="n">previousClass</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">_moduleSetUpFailed</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">currentClass</span><span class="p">,</span> <span class="s2">&quot;__unittest_skip__&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">currentClass</span><span class="o">.</span><span class="n">_classSetupFailed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="c1"># test may actually be a function</span>
        <span class="c1"># so its class will be a builtin-type</span>
        <span class="k">pass</span>

    <span class="n">setUpClass</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">currentClass</span><span class="p">,</span> <span class="s1">&#39;setUpClass&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">setUpClass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_call_if_exists</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;_setupStdout&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">setUpClass</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">_DebugResult</span><span class="p">):</span>
                <span class="k">raise</span>
            <span class="n">currentClass</span><span class="o">.</span><span class="n">_classSetupFailed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">className</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">strclass</span><span class="p">(</span><span class="n">currentClass</span><span class="p">)</span>
            <span class="n">errorName</span> <span class="o">=</span> <span class="s1">&#39;setUpClass (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">className</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addClassOrModuleLevelException</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">errorName</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">_call_if_exists</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;_restoreStdout&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>如果两者相同，则不用执行setUpClass方法，否则表示是其他TestCase-subclass所属的test，
那么需要执行setUpClass方法，并更新_previousTestClass。通过该属性，
能保证setUpClas/ tearDownClass对每个类只会执行一次。</p>
<p>对代码进行讲解，是一件很费力的事情。请大家参考unittest代码，进行分析。</p>
</div>
</div>
<div class="section" id="id5">
<h2><a class="toc-backref" href="#id13">21.3. 参考</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td><a class="reference external" href="https://huilansame.github.io/huilansame.github.io/archivers/python">https://huilansame.github.io/huilansame.github.io/archivers/python</a>-unittest#进阶用htmltestrunner输出漂亮的html报告</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[2]</td><td><a class="reference external" href="http://lucia.xicp.cn/2016/05/16/python/python%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95unittest/">http://lucia.xicp.cn/2016/05/16/python/python%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95unittest/</a></td></tr>
</tbody>
</table>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../linux_tools/index.html" class="btn btn-neutral float-right" title="Hack Linux" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="django-i18n.html" class="btn btn-neutral float-left" title="20. django国际化" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ZT

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>