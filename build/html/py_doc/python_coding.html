

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>8. Python 编码问题总结 &mdash; openstack 1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="9. Python 装饰器、闭包" href="dec_logic.html" />
    <link rel="prev" title="7. Python学习总结" href="python_notebook.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> openstack
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Python Note</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="pysnmp_doc.html">1. [翻译] PySNMP教程</a></li>
<li class="toctree-l2"><a class="reference internal" href="pysnmp_doc_example.html">2. PySNMP获取设备信息</a></li>
<li class="toctree-l2"><a class="reference internal" href="re_doc.html">3. [翻译] Python正则表达式</a></li>
<li class="toctree-l2"><a class="reference internal" href="wsgi.html">4. WSGI基础</a></li>
<li class="toctree-l2"><a class="reference internal" href="re_analysis.html">5. Python正则表达式分析利器</a></li>
<li class="toctree-l2"><a class="reference internal" href="python_descriptor.html">6. Python描述器</a></li>
<li class="toctree-l2"><a class="reference internal" href="python_notebook.html">7. Python学习总结</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">8. Python 编码问题总结</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">8.1. 系统默认编码</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id4">8.1.1. 源文件编码</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sys-stdin-encodingsys-stdout-encoding">8.1.2. sys.stdin.encoding和sys.stdout.encoding</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sys-getdefaultencoding">8.1.3. sys.getdefaultencoding()</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id6">8.2. 文本串/字节串混合操作</a></li>
<li class="toctree-l3"><a class="reference internal" href="#python2-xstring">8.3. Python2.x中的string</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">8.4. 最佳实践</a></li>
<li class="toctree-l3"><a class="reference internal" href="#python-unicode-howto">8.5. Python unicode HowTo</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id9">8.5.1. 编码定义</a></li>
<li class="toctree-l4"><a class="reference internal" href="#unicode">8.5.2. 读写unicode数据</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#wsgi-http">8.6. WSGI/HTTP编码问题</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id10">8.7. 参考</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="dec_logic.html">9. Python 装饰器、闭包</a></li>
<li class="toctree-l2"><a class="reference internal" href="webob_analysis.html">10. webob库简单分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="metaclass_intro.html">11. Python元类</a></li>
<li class="toctree-l2"><a class="reference internal" href="os_lib.html">12. Python Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="log_summary.html">13. logging 模块总结</a></li>
<li class="toctree-l2"><a class="reference internal" href="django_note.html">14. django笔记</a></li>
<li class="toctree-l2"><a class="reference internal" href="python_path.html">15. Python文件与目录操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="sqlalchemy.html">16. sqlalchemy笔记</a></li>
<li class="toctree-l2"><a class="reference internal" href="time_date.html">17. Python时间和日期操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="pecan_note.html">18. pecan学习示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="stevedemo.html">19. stevedore库学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="django-i18n.html">20. django国际化</a></li>
<li class="toctree-l2"><a class="reference internal" href="unittest.html">21. unittest单元测试</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../linux_tools/index.html">Hack Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../openstack/index.html">OpenStack Note</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network/index.html">网络技术/neutron</a></li>
<li class="toctree-l1"><a class="reference internal" href="../others/index.html">未分类</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">openstack</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Python Note</a> &raquo;</li>
        
      <li>8. Python 编码问题总结</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/py_doc/python_coding.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="python">
<h1><a class="toc-backref" href="#id15">8. Python 编码问题总结</a><a class="headerlink" href="#python" title="Permalink to this headline">¶</a></h1>
<p>注意：如没有特别说明，所有的描述均针对Python2.x。试验验证一般采用的Ubuntu-14.04-LTS Python2.7。</p>
<div class="contents topic" id="id1">
<p class="topic-title first">目录</p>
<ul class="simple">
<li><a class="reference internal" href="#python" id="id15">Python 编码问题总结</a><ul>
<li><a class="reference internal" href="#id2" id="id16">系统默认编码</a><ul>
<li><a class="reference internal" href="#id4" id="id17">源文件编码</a></li>
<li><a class="reference internal" href="#sys-stdin-encodingsys-stdout-encoding" id="id18">sys.stdin.encoding和sys.stdout.encoding</a></li>
<li><a class="reference internal" href="#sys-getdefaultencoding" id="id19">sys.getdefaultencoding()</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6" id="id20">文本串/字节串混合操作</a></li>
<li><a class="reference internal" href="#python2-xstring" id="id21">Python2.x中的string</a></li>
<li><a class="reference internal" href="#id8" id="id22">最佳实践</a></li>
<li><a class="reference internal" href="#python-unicode-howto" id="id23">Python unicode HowTo</a><ul>
<li><a class="reference internal" href="#id9" id="id24">编码定义</a></li>
<li><a class="reference internal" href="#unicode" id="id25">读写unicode数据</a></li>
</ul>
</li>
<li><a class="reference internal" href="#wsgi-http" id="id26">WSGI/HTTP编码问题</a></li>
<li><a class="reference internal" href="#id10" id="id27">参考</a></li>
</ul>
</li>
</ul>
</div>
<hr class="docutils" />
<p>Python蛋疼的编码问题，陆陆续续遇到过很多次了。原来在爬取网页时，
就遇到过网页乱码；最近测试wsgi程序时，又遇到 <cite>AssertionError: write() argument must be string</cite> 问题。
原来Python编码问题就做过相关总结，今天又探索了一番，记录下来，以作参考。</p>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id16">8.1. 系统默认编码</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>Python2.x 中有多个不同的系统默认编码。</p>
<table class="docutils footnote" frame="void" id="id3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td><a class="reference external" href="https://gist.github.com/x7hub/178c87f323fbad57ff91">https://gist.github.com/x7hub/178c87f323fbad57ff91</a></td></tr>
</tbody>
</table>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id17">8.1.1. 源文件编码</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>一般在源文件开头，通过指定：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#coding:utf-8</span>
<span class="c1">#coding=utf-8</span>
</pre></div>
</div>
<p>来设置当源文件中有飞拉丁字符时的情况(如中文注释)。如果没有指定，系统就会默认使用ascii对源文件编码，会出现不能识别中文的情况。</p>
</div>
<div class="section" id="sys-stdin-encodingsys-stdout-encoding">
<h3><a class="toc-backref" href="#id18">8.1.2. sys.stdin.encoding和sys.stdout.encoding</a><a class="headerlink" href="#sys-stdin-encodingsys-stdout-encoding" title="Permalink to this headline">¶</a></h3>
<p>sdtin和stdout输入输出使用的编码，包括命令行参数和print输出，由locale环境变量决定。在en_US.UTF-8的系统中，默认值是UTF-8。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">sys</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">encoding</span>
<span class="go">&#39;UTF-8&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span>
<span class="go">&#39;UTF-8&#39;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="sys-getdefaultencoding">
<h3><a class="toc-backref" href="#id19">8.1.3. sys.getdefaultencoding()</a><a class="headerlink" href="#sys-getdefaultencoding" title="Permalink to this headline">¶</a></h3>
<p><strong>在Python2.x中：只有unicode对象才是真正意义的文本串，str类型表示的字节序列</strong> 。Python2文本串和字节序列可以进行拼接、格式化等混合操作。混合操作过程不可编码的涉及到编码转换(Python解释器隐式进行)，因此Python2中，涉及到编码隐式转换的，都会使用sys.getdefaultencoding()进行.【参考stackoverflow，再加上个人理解！】</p>
<p><cite>sys.getdefaultencoding() is used on Python 2 for implicit conversions (when the encoding is not set explicitly) i.e., Python 2 may mix ascii-only bytestrings and Unicode strings together e.g., xml.etree.ElementTree stores text in ascii range as bytestrings or json.dumps() returns an ascii-only bytestring instead of Unicode in Python 2 — perhaps due to performance — bytes were cheaper than Unicode for representing ascii characters. Implicit conversions are forbidden in Python 3.</cite></p>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[2]</td><td><a class="reference external" href="http://stackoverflow.com/questions/15530635/why-is-sys-getdefaultencoding-different-from-sys-stdout-encoding-and-how-does">http://stackoverflow.com/questions/15530635/why-is-sys-getdefaultencoding-different-from-sys-stdout-encoding-and-how-does</a></td></tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="id6">
<h2><a class="toc-backref" href="#id20">8.2. 文本串/字节串混合操作</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<p>前文提到，Python2.x中文本串(unicode对象)和字节串(str类型对象)可以混合操作。中间涉及到的编码隐式转换由Python解释器自动完成。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="s1">&#39;&lt;+ a:</span><span class="si">%s</span><span class="s1"> +&gt; &#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;{b:</span><span class="si">%s</span><span class="s1">} &#39;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span> <span class="nb">type</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
<span class="go">&lt;type &#39;unicode&#39;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span> <span class="nb">type</span><span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="n">a</span><span class="p">)</span>
<span class="go">&lt;type &#39;unicode&#39;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span> <span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="o">%</span><span class="n">b</span><span class="p">)</span>
<span class="go">&lt;type &#39;unicode&#39;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span> <span class="nb">type</span><span class="p">(</span><span class="n">b</span><span class="o">%</span><span class="n">a</span><span class="p">)</span>
<span class="go">&lt;type &#39;unicode&#39;&gt;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p><strong>可以看到，文本串和字节串混合操作时，一律都是str对象转换成unicode然后操作。结果类型也一律是unicode对象！</strong></p>
<p>假如混合操作时有非拉丁字母，会怎样呢？</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sys</span><span class="o">.</span><span class="n">getdefaultencoding</span><span class="p">()</span>
<span class="go">&#39;ascii&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="s1">&#39;&lt;+ 你好:</span><span class="si">%s</span><span class="s1"> +&gt; &#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;{中国:</span><span class="si">%s</span><span class="s1">} &#39;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span> <span class="nb">type</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
<span class="gr">UnicodeDecodeError</span>: <span class="n">&#39;ascii&#39; codec can&#39;t decode byte 0xe4 in position 3: ordinal not in range(128)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span> <span class="n">a</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span>
<span class="go">&lt;+ 你好:%s +&gt; {中国:%s}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="go">&lt;+ 你好:%s +&gt; {中国:%s}</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">reload</span><span class="p">(</span><span class="n">sys</span><span class="p">)</span>
<span class="go">&lt;module &#39;sys&#39; (built-in)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sys</span><span class="o">.</span><span class="n">setdefaultencoding</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span> <span class="nb">type</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
<span class="go">&lt;type &#39;unicode&#39;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span> <span class="nb">type</span><span class="p">(</span><span class="n">b</span><span class="o">%</span><span class="n">a</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span>
<span class="go">&#39;&lt;+ \xe4\xbd\xa0\xe5\xa5\xbd:%s +&gt; &#39;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>不出意外，果然混合操作失败了。根据异常信息，可以看到，系统隐式转换时
尝试使用ascii对a字节序列进行编码。 <code class="docutils literal notranslate"><span class="pre">\xe4</span></code> 超出了ascii的编码范围，所以
编码转换失败。</p>
<p>通过 setdefaultencoding(“utf-8”)，后面的操作都成功了。但是，需要注意的是，该操作虽然可以解决中文乱码问题，但是也可能带来其他bug。要避免使用，我们Python项目中，也很少发现该用法。</p>
<table class="docutils footnote" frame="void" id="id7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[3]</td><td><a class="reference external" href="http://blog.ernest.me/post/python-setdefaultencoding-unicode-bytes">http://blog.ernest.me/post/python-setdefaultencoding-unicode-bytes</a></td></tr>
</tbody>
</table>
</div>
<div class="section" id="python2-xstring">
<h2><a class="toc-backref" href="#id21">8.3. Python2.x中的string</a><a class="headerlink" href="#python2-xstring" title="Permalink to this headline">¶</a></h2>
<p>Python为了让其语法看上去简洁好用，做了很多tricky的事情，混淆byte string和text string就是其中一例。</p>
<p>在 Python 里，有三大类 string 类型：</p>
<ul class="simple">
<li>unicode（text string），</li>
<li>str（byte string，二进制数据），</li>
<li>basestring，是前两者的父类。</li>
</ul>
<p>其实，在语言设计领域，一串字节（sequences of bytes）是否应该当做字符串（string）一直是存在争议的。我们熟知的 Java 和 C# 投了反对票，而 Python 则站在了支持者的阵营里。其实我们在很多情况下，给文本做的操作，比如正则匹配、字符替换等，对于字节来说是用不着的。而 Python 认为字节就是字符，所以他们俩的操作集合是一致的。</p>
<p>然后进一步的，Python 会在必要的情况下，尝试对字节做自动类型转换，例如，在上文中的 ==，或者字节和文本拼接时。如果没有一个编码（encoding），两个不同类型之间的转换是无法进行的，于是，Python 需要一个默认编码。在 Python2 诞生的年代，ASCII 是最流行的（可以这么说吧），于是 Python2 选择了ASCII。然而，众所周知，在需要需要转换的场景，ASCII 都是没用的（128个字符，够什么吃）。</p>
<p>在历经这么多年吐槽后，Python 3 终于学乖了。默认编码是Unicode，这也就意味着，做所有需要转换的场合，都能正确并成功的转换。</p>
</div>
<div class="section" id="id8">
<h2><a class="toc-backref" href="#id22">8.4. 最佳实践</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p>在Python2.x中，编码问题尽量遵循下列原则。</p>
<ul class="simple">
<li>所有 text string 都应该是 unicode 类型，而不是 str，如果你在操作 text，而类型却是 str，那就是在制造 bug。</li>
<li>在需要转换的时候，显式转换。从字节解码成文本，用var.decode(encoding)，从文本编码成字节，用 var.encode(encoding)。</li>
<li>从外部读取数据时，默认它是字节，然后 decode 成需要的文本；同样的，当需要向外部发送文本时，encode 成字节再发送。</li>
</ul>
</div>
<div class="section" id="python-unicode-howto">
<h2><a class="toc-backref" href="#id23">8.5. Python unicode HowTo</a><a class="headerlink" href="#python-unicode-howto" title="Permalink to this headline">¶</a></h2>
<p>该节的大部分内容，来源于Python官网Python HowTo,强烈推荐。英文看起来也一点都不难！</p>
<div class="section" id="id9">
<h3><a class="toc-backref" href="#id24">8.5.1. 编码定义</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>unicode定义了字符集和码点(code point)的映射，一个unicode string就是一系列unicode码点序列。该码点序列在计算机内存中需要有种表示方式，定义unicode string码点序列到内存字节序列的转换规则就称之为编码。</p>
</div>
<div class="section" id="unicode">
<h3><a class="toc-backref" href="#id25">8.5.2. 读写unicode数据</a><a class="headerlink" href="#unicode" title="Permalink to this headline">¶</a></h3>
<p>一旦程序涉及到操作unicode 数据的代码，下一个问题就是I/O。你的程序从哪里获得unicode数据？怎样把unicode数据转换成合适的格式以供传输和存储？</p>
<p>根据你的数据输入源和输出目的地，有时你可能什么都不用做，你只需要检查你程序中所使用的库是否原声的支持unicode。比如XML解析库一般都直接返回unicode数据；许多关系数据库都支持unicode列存储和unicode SQL查询！</p>
<p>但是unicode数据写到磁盘上或者传送到socket时，一般都会转换成特定的格式。但是这时我们需要注意的是读取不完整unicode的问题。</p>
</div>
</div>
<div class="section" id="wsgi-http">
<h2><a class="toc-backref" href="#id26">8.6. WSGI/HTTP编码问题</a><a class="headerlink" href="#wsgi-http" title="Permalink to this headline">¶</a></h2>
<p>通常，http协议处理的是字节序列(HTTP 协议也不直接支持unicode，来源于PEP-3333)，因此，wsgi规范涉及到的string一般都是bytestring。近期测试webob程序的时候，程序总是报错。原来wsgi app要求假如返回字符串类型，则只能是str类型，而不能是unicode类型。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">simple_app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;200 OK&#39;</span>
    <span class="n">response_headers</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;Content-type&#39;</span><span class="p">,</span><span class="s1">&#39;text/plain&#39;</span><span class="p">)]</span>
    <span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">)</span>
    <span class="c1"># app 的返回值不能是 unicode 对象！</span>
    <span class="k">return</span> <span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Hello world!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">]</span>
    <span class="c1">#return [&#39;Hello world!\n&#39;]</span>
</pre></div>
</div>
<p>simple_app返回的可迭代对象元素是unicode类型，因此curl请求时，报错如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="n">StringType</span><span class="p">,</span><span class="s2">&quot;write() argument must be string&quot;</span>
<span class="ne">AssertionError</span><span class="p">:</span> <span class="n">write</span><span class="p">()</span> <span class="n">argument</span> <span class="n">must</span> <span class="n">be</span> <span class="n">string</span>
<span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="o">-</span> <span class="o">-</span> <span class="p">[</span><span class="mi">20</span><span class="o">/</span><span class="n">Nov</span><span class="o">/</span><span class="mi">2016</span> <span class="mi">20</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">40</span><span class="p">]</span> <span class="s2">&quot;GET / HTTP/1.1&quot;</span> <span class="mi">500</span> <span class="mi">59</span>
</pre></div>
</div>
<p>请看pep-3333 wsgi规范关于unicode 的描述：</p>
<p>HTTP does not directly support Unicode, and neither does this interface. All encoding/decoding must be handled by the application; all strings passed to or from the server must be of type str or bytes , never unicode . The result of using a unicode object where a string object is required, is undefined.</p>
<p>HTTP协议不直接支持unicode，它的接口也不支持。因此app需要处理encoding/decoding：所有的strings(server传来的和传递给server的)都只能是str类型或者bytes类型，决不能是unicode。在需要string对象而返回unicode对象的地方，结果是未定义的！</p>
<p>Note also that strings passed to start_response() as a status or as response headers must follow RFC 2616 with respect to encoding. That is, they must either be ISO-8859-1 characters, or use RFC 2047 MIME encoding.</p>
<p>同样需要指出：传递给 start_response 回调函数的strings(作为HTTP 响应状态码和头部)需要服从RFC-2616的编码规定。因此：他们只可能是ISO-8859-1字符集或者RFC-2047多媒体编码！</p>
<p>On Python platforms where the str or StringType type is in fact Unicode-based (e.g. Jython, IronPython, Python 3, etc.), all “strings” referred to in this specification must contain only code points representable in ISO-8859-1 encoding ( u0000 through u00FF , inclusive). It is a fatal error for an application to supply strings containing any other Unicode character or code point. Similarly, servers and gateways must not supply strings to an application containing any other Unicode characters.</p>
<p>在python平台上，str和StringType类型都是基于unicode的(如：Jython, IronPython, Python3);该规范里涉及到的所有strings只能包含 ISO-8859-1编码规则列出的码点。wsgi app 提供包含任意其他unicode字符集或者码点的strings都是严重错误。类似的，servers或者gateway也不应该给一个app提供包含其他unicode字符集的strings</p>
<p>Again, all objects referred to in this specification as “strings” must be of type str or StringType , and must not be of type unicode or UnicodeType . And, even if a given platform allows for more than 8 bits per character in str / StringType objects, only the lower 8 bits may be used, for any value referred to in this specification as a “string”.</p>
<p>再次强调：该规范里涉及的所有string对象只能是str或者StringType，而不能是unicode 或者UnicodeType；即使有些平台str或者StringType对象支持超过 8bits/每字符，也可能只有低8位字符可用。</p>
<p>For values referred to in this specification as “bytestrings” (i.e., values read from wsgi.input , passed to write() or yielded by the application), the value must be of type bytes under Python 3, and str in earlier versions of Python.</p>
<p>如果该规范里涉及到的值为”bytestrings“(如：wsgi.input, 传递给write(),或者由app yield产生)，他们的类型只能是bytes(在Python3中)，或者str(以前的Python版本！)</p>
</div>
<hr class="docutils" />
<div class="section" id="id10">
<h2><a class="toc-backref" href="#id27">8.7. 参考</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h2>
<table class="docutils footnote" frame="void" id="id11" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[4]</td><td><a class="reference external" href="http://pycoders-weekly-chinese.readthedocs.io/en/latest/issue5/unipain.html">http://pycoders-weekly-chinese.readthedocs.io/en/latest/issue5/unipain.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id12" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[5]</td><td><a class="reference external" href="http://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/001431664106267f12e9bef7ee14cf6a8776a479bdec9b9000">http://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/001431664106267f12e9bef7ee14cf6a8776a479bdec9b9000</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id13" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[6]</td><td><a class="reference external" href="http://www.ituring.com.cn/article/1116">http://www.ituring.com.cn/article/1116</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id14" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[7]</td><td><a class="reference external" href="https://www.python.org/dev/peps/pep-3333/#unicode-issues">https://www.python.org/dev/peps/pep-3333/#unicode-issues</a></td></tr>
</tbody>
</table>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="dec_logic.html" class="btn btn-neutral float-right" title="9. Python 装饰器、闭包" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="python_notebook.html" class="btn btn-neutral float-left" title="7. Python学习总结" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ZT

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>